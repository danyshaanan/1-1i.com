<html lang=en>
<body>

<script>
'use strict'

////////////////////// Canvas class ////////////////////////////////////////////

function Canvas(width, height) {
  var canvas = this.canvas = document.createElement('canvas')
  canvas.width  = width
  canvas.height = height
  var ctx = canvas.getContext('2d')
  var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
  this.set = function(x, y, c) {
    var index = (canvas.width * y + x) << 2
    imageData.data[index+0] = c.r % 256
    imageData.data[index+1] = c.g % 256
    imageData.data[index+2] = c.b % 256
    imageData.data[index+3] = 255
  }
  this.drawPixels = function(cb) {
    for (var y = 0; y < canvas.height; ++y) {
      for (var x = 0; x < canvas.width; ++x) {
        this.set(x, y, cb(x, y))
      }
    }
    ctx.putImageData(imageData, 0, 0)
  }
  document.body.appendChild(canvas)
}

////////////////////// Logic ///////////////////////////////////////////////////

function hueToRgb(h){
    function hueToC(t){
        if (t < 1/6) return  6 * (t      )
        if (t < 1/2) return  1
        if (t < 2/3) return -6 * (t - 2/3)
        return 0
    }
    return {
      r: 255 * hueToC((h + 1/3)%1),
      g: 255 * hueToC( h       %1),
      b: 255 * hueToC((h + 2/3)%1)
    }
}

var r2 = Math.pow(8, 2)
var oneByLogR2 = 1/Math.log(r2)

function iterations(x0, y0, max) {
  var x = 0
  var y = 0
  var i = 0
  while (++i < max && x*x + y*y < r2) {
    var tx = x*x - y*y + x0
    y = 2*x*y + y0
    x = tx
  }
  if (i < max) return i - Math.log(x*x + y*y)*oneByLogR2
}

function color(i) {
  return hueToRgb(i/20)
}

////////////////////// Execution ///////////////////////////////////////////////

var def = { cx: -3, cy: -1.5, zoom: 0.005, i: 100 }

function getColor(x, y) {
  return color(iterations(x * def.zoom + def.cx, y * def.zoom + def.cy, def.i))
}

var canvas = new Canvas(1000, 600)
canvas.drawPixels(getColor)

////////////////////// Keyboard ////////////////////////////////////////////////

var actions = {
  73: function() { def.i += 50 }, //i
  79: function() { def.i -= 50 }, //o
  83: function() { window.localStorage.def = JSON.stringify(def) }, //s
  76: function() { def = JSON.parse(window.localStorage.def) }, //l
}

document.onkeyup = function(e){
  if (actions[e.keyCode]) {
    e.preventDefault()
    actions[e.keyCode]()
    canvas.drawPixels(getColor)
  }
}

////////////////////// Mouse ///////////////////////////////////////////////////

function zoomAround(zoom, mouseEvent) {
  def.cx += mouseEvent.layerX * def.zoom
  def.cy += mouseEvent.layerY * def.zoom
  def.zoom *= zoom
  def.cx -= mouseEvent.layerX * def.zoom
  def.cy -= mouseEvent.layerY * def.zoom
}

var downE
document.oncontextmenu = function(e) { return false }
document.onmousedown = function(e) { downE = e }
document.onmouseup = function(upE) {
  var diff = { x: downE.layerX - upE.layerX, y: downE.layerY - upE.layerY }
  if (diff.x || diff.y) {
    def.cx += diff.x * def.zoom
    def.cy += diff.y * def.zoom
  } else {
    zoomAround(upE.which === 1 ? 0.5 : 2, upE)
  }
  canvas.drawPixels(getColor)
}


window.onwheel = function(e) {
  zoomAround(Math.pow(2, Math.sign(e.wheelDelta)), e)
  canvas.drawPixels(getColor)
  return false
}

////////////////////////////////////////////////////////////////////////////////


</script>

</body>
</html>
