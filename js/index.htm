<html lang=en>
<body>

<script>
'use strict'

function Canvas(width, height) {
  var canvas = this.canvas = document.createElement('canvas')
  canvas.width  = width
  canvas.height = height
  var ctx = canvas.getContext('2d')
  var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
  this.set = function(x, y, c) {
    var index = (canvas.width * y + x) << 2
    imageData.data[index+0] = c.r % 256
    imageData.data[index+1] = c.g % 256
    imageData.data[index+2] = c.b % 256
    imageData.data[index+3] = 255
  }
  this.translate = function(x, y, def) {
    return {
      x: x * def.zoom + def.cx,
      y: y * def.zoom + def.cy
    }
  }
  this.drawPixels = function(cb) {
    for (var y = 0; y < canvas.height; ++y) {
      for (var x = 0; x < canvas.width; ++x) {
        this.set(x, y, cb(x, y))
      }
    }
    ctx.putImageData(imageData, 0, 0)
  }
  document.body.appendChild(canvas)
}

////////////////////////////////////////////////////////////////////////////////
var r2 = Math.pow(8, 2)
var oneByLogR2 = 1/Math.log(r2)

function iterations(p0, max) {
  var x = 0
  var y = 0
  var i = 0
  while (++i < max && x*x + y*y < r2) {
    var tx = x*x - y*y + p0.x
    y = 2*x*y + p0.y
    x = tx
  }
  if (i < max) return i - Math.log(x*x + y*y)*oneByLogR2
}

function color(i) {
  return {
    r: i && 128 + 127 * Math.sin(2 * Math.PI * i / 2),
    g: i && 128 + 127 * Math.sin(2 * Math.PI * i / 5),
    b: i &&  40 + 40 * Math.sin(2 * Math.PI * i / 13),
  }
}

////////////////////////////////////////////////////////////////////////////////

var actions = {
  73: function() { def.i += 50 }, //i
  79: function() { def.i -= 50 }, //o
  83: function() { window.localStorage.def = JSON.stringify(def) }, //s
  76: function() { def = JSON.parse(window.localStorage.def) }, //l
}

var def = { cx: -3, cy: -1.5, zoom: 0.005, i: 100 }
var canvas = new Canvas(1000, 600)

function getColor(x, y) {
  return color(iterations(canvas.translate(x, y, def), def.i))
}

canvas.drawPixels(getColor)

document.onkeyup = function(e){
  if (actions[e.keyCode]) {
    e.preventDefault()
    actions[e.keyCode]()
    canvas.drawPixels(getColor)
  }
}

var downE
document.oncontextmenu = function(e) { return false }
document.onmousedown = function(e) { downE = e }
document.onmouseup = function(upE) {
  var diff = { x: downE.layerX - upE.layerX, y: downE.layerY - upE.layerY }
  if (diff.x || diff.y) {
    def.cx += diff.x * def.zoom
    def.cy += diff.y * def.zoom
  } else {
    def.cx += upE.layerX * def.zoom
    def.cy += upE.layerY * def.zoom
    def.zoom *= upE.which === 1 ? 0.5 : 2
    def.cx -= upE.layerX * def.zoom
    def.cy -= upE.layerY * def.zoom
  }
  canvas.drawPixels(getColor)
}

</script>

</body>
</html>
